# dynamic-formula-comparison
AST ו  SP מנגנון חישוב דינמי המשתמש ב
**דוח מסכם: השוואת ביצועים - מנגנוני חישוב נוסחאות דינמיות**

**1\. ניתוח השוואתי של זמני ביצוע**

דוח זה מציג את השוואת הביצועים בין שתי שיטות לחישוב נוסחאות דינמיות על מערך נתונים גדול (כ-1.0 מיליון רשומות, 16 נוסחאות שונות). המטרה היא לבחור את השיטה האפקטיבית והמהירה ביותר למערכת התשלומים.

**טבלת סיכום ביצועים**

| **מדד** | **Safe AST (Python)** | **DB_SP (SQL Server)** |
| --- | --- | --- |
| **סה"כ רשומות מעובדות** | 16,000,000 | 16,000,000 |
| **סה"כ זמן ריצה** | **8.7954 שניות** | **95.9140 שניות** |
| **ממוצע זמן לנוסחה (עיבוד Batch)** | **0.55 שניות** | **5.99 שניות** |
| **יחס ביצועים** | **המהירה ביותר** | איטית פי **10.9** |

**מסקנות ביצועים**

הנתונים מוכיחים באופן חד-משמעי כי שיטת **Safe AST** עולה באופן דרמטי על שיטת ה-DB_SP במימוש הנוכחי:

- **עליונות ה-AST:** שיטת הפייתון הצליחה לסיים את העיבוד כולו בפחות מ-9 שניות, וזאת על ידי טעינה יעילה של הנתונים לזיכרון ה-RAM וביצוע החישוב המהיר ב-CPU של שרת היישומים.
- **צוואר בקבוק ב-DB_SP:** הביצועים האיטיים של ה-DB_SP נובעים ככל הנראה מהתקורה (Overhead) הגבוהה של **הפעלת SQL דינמי חוזר ונשנה** בתוך ה-Stored Procedure. במקום לבצע פעולת Bulk אחת אופטימלית, הלולאה אילצה את מנוע ה-SQL Server לעשות **Planning ו-Parsing** מחדש עבור כל אחת מ-16 הנוסחאות, ובכך בזבזה זמן יקר.

**2\. הסבר קצר על השיטות**

**א. Safe AST (Python)**

- **מהות:** שיטה המבוססת על פירוק הנוסחה לעץ תחביר מופשט (Abstract Syntax Tree).
- **בטיחות:** לפני ההרצה, השיטה מבצעת **Sandboxing** כדי לוודא שאין בקוד פונקציות מסוכנות (כגון גישה לקבצים או למערכת ההפעלה), ובכך שומרת על בטיחות המערכת.
- **יעילות (נצפית):** יעילה במיוחד לעיבוד סדרתי על נתונים שכבר נטענו לזיכרון.

**ב. DB Stored Procedure (DB_SP)**

- **מהות:** שיטה המבצעת את החישוב באמצעות קוד המאוחסן ישירות בשרת מסד הנתונים (T-SQL).
- **אופן הפעולה:** הקוד בונה שאילתת SQL דינמית (INSERT INTO...SELECT...) עבור כל נוסחה.
- **יעילות (נצפית):** במקום לנצל את יכולות ה-Bulk של ה-DB, המימוש הנוכחי נפל בשל שימוש בלולאה חוזרת שגרמה לתקורה גבוהה ועיכבה את ביצוע ה-SQL הדינמי.

**3\. המלצה על השיטה הטובה ביותר**

**המלצה סופית: Safe AST (Python)**

בהתבסס על תוצאות הביצועים האמתיות שהושגו על מערך הנתונים הגדול:

**ההמלצה היא לאמץ את שיטת Safe AST כשיטת החישוב המרכזית והמועדפת למערכת התשלומים.**

**נימוקים להמלצה:**

- **ביצועים עדיפים:** השיטה הוכיחה שהיא מהירה **פי 10.9** מהאלטרנטיבה, וזהו גורם קריטי במערכת הדורשת עיבוד מהיר של אצווה (Batch).
- **אחזקה וגמישות:** שימוש בפייתון (AST) מאפשר גמישות גבוהה יותר בהוספת פונקציות מתמטיות מורכבות וקל יותר לאחזקה על ידי צוות הפיתוח מאשר תחזוקת קוד SQL דינמי.
- **בטיחות:** השיטה שומרת על רמת בטיחות גבוהה הודות למנגנון ה-AST המונע הרצת קוד זדוני.